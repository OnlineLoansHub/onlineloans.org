<!DOCTYPE html>
<html>

<head>
    <title>Subir PDF a Supabase Storage</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>

        const supabase = window.supabase.createClient(
            "https://wndvkcghmlknzpvocvsa.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InduZHZrY2dobWxrbnpwdm9jdnNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDAwNzA2MjEsImV4cCI6MjA1NTY0NjYyMX0.UiiLj4rgNk8EfZDEdfxtutub3Vsu-t9MfLA-FgT3Zms"
        );
    </script>

    <style>
        .drop-zone {
            width: 400px;
            height: 200px;
            border: 2px dashed #ccc;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            margin: 20px auto;
            padding: 20px;
            cursor: pointer;
        }

        .drop-zone.dragover {
            border-color: #2196F3;
            background-color: #f0f8ff;
        }

        #file-list {
            margin: 20px auto;
            width: 400px;
        }

        button {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .status {
            text-align: center;
            margin: 20px;
        }
    </style>
</head>

<body>
    <div class="drop-zone" id="dropZone">
        <p>Arrastra tus archivos PDF aqu√≠ o haz clic para seleccionar</p>
        <input type="file" id="fileInput" accept=".pdf" multiple hidden>
    </div>
    <div id="file-list"></div>
    <button id="submitBtn" disabled>Enviar Archivos</button>
    <div class="status" id="status"></div>

    <script>



        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const submitBtn = document.getElementById('submitBtn');
        const fileList = document.getElementById('file-list');
        const statusDiv = document.getElementById('status');
        let files = [];


        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(newFiles) {
            const validFiles = Array.from(newFiles).filter(file =>
                file.type === 'application/pdf'
            );

            files = [...files, ...validFiles];
            updateFileList();
            submitBtn.disabled = files.length === 0;
        }

        function updateFileList() {
            fileList.innerHTML = files.map(file =>
                `<div>${file.name} (${(file.size / 1024).toFixed(2)} KB)</div>`
            ).join('');
        }


        async function uploadPDF(file) {
            if (!file) return;

            const fileName = `pdfs/${Date.now()}-${file.name}`;

            const { data, error } = await supabase.storage
                .from("pdfs")
                .upload(fileName, file, {
                    contentType: "application/pdf"
                });

            if (error) {
                console.error("Error al subir el archivo:", error);
                alert("Hubo un error al subir el archivo.");
                return null;
            } else {
                console.log("Archivo subido:", data);
                return data.path;
            }
        }


        submitBtn.addEventListener('click', async () => {
            submitBtn.disabled = true;
            statusDiv.textContent = 'Enviando archivos...';

            try {
                for (const file of files) {
                    const filePath = await uploadPDF(file);
                    if (!filePath) throw new Error("Error al subir el archivo.");


                    const publicUrl = `https://wndvkcghmlknzpvocvsa.supabase.co/storage/v1/object/public/${filePath}`;
                    console.log("Archivo disponible en:", publicUrl);

                    statusDiv.innerHTML += `<p>Archivo subido: <a href="${publicUrl}" target="_blank">${file.name}</a></p>`;
                }

                files = [];
                updateFileList();
            } catch (error) {
                statusDiv.textContent = `Error: ${error.message}`;
            } finally {
                submitBtn.disabled = false;
            }
        });
    </script>
</body>

</html>